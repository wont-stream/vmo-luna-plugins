name: "Validate & Build"

on:
  workflow_call:

jobs:
  Sanity:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Modify package.json for dev branch
        run: |
          if [ "${{ github.ref_name }}" = "dev" ]; then
            sed -i 's/"@vmohammad\/plugins"/"@vmohammad\/plugins (dev)"/g' package.json
            echo "Modified package.json name for dev branch"
          else
            echo "Not on dev branch, keeping original package.json name"
          fi

      - name: Delete Unwanted plugins for production
        run: |
          if [ "${{ github.ref_name }}" = "master" ]; then
            rm -rf plugins/betterPlayer plugins/lrclib plugins/translate # lrclib is broken as of now, betterPlayer requires an exe that doesnt get auto installed
            echo "Deleted unwanted plugins for production build"
          else
            echo "Not on master branch, keeping all plugins"
          fi

      - name: Install pnpm ðŸ“¥
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install Node.js ðŸ“¥
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: latest

      - name: Install dependencies ðŸ“¥
        run: pnpm install

      - name: Build
        run: pnpm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luna-artifacts
          path: ./dist
